version: "3"

vars:
  BINARY_NAME: prgen
  MAIN_PKG: .

tasks:
  build:
    desc: Build the Go binary
    cmds:
      - echo "ğŸ”¨ Building {{.BINARY_NAME}}..."
      - go build -o bin/{{.BINARY_NAME}} {{.MAIN_PKG}}
      - echo "âœ… Built at bin/{{.BINARY_NAME}}"

  install:
    desc: Build and install globally to /usr/local/bin
    deps: [build]
    cmds:
      - echo "ğŸ“¦ Installing {{.BINARY_NAME}} to /usr/local/bin..."
      - sudo install -m 0755 bin/{{.BINARY_NAME}} /usr/local/bin/{{.BINARY_NAME}}
      - echo "âœ… Installed globally as '{{.BINARY_NAME}}'"

  clean:
    desc: Remove build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - rm -rf bin

  release:
    desc: Create a new release (requires version, e.g., task release VERSION=0.2.0)
    preconditions:
      - sh: test -n "{{.VERSION}}"
        msg: "VERSION is required. Usage: task release VERSION=0.2.0"
      - sh: test -n "$GITHUB_TOKEN"
        msg: "GITHUB_TOKEN env var must be set"
    cmds:
      - echo "ğŸ·ï¸  Creating tag v{{.VERSION}}..."
      - git tag v{{.VERSION}}
      - echo "ğŸš€ Pushing tag to origin..."
      - git push origin v{{.VERSION}}
      - echo "ğŸ“¦ Running GoReleaser..."
      - goreleaser release --clean
      - echo "âœ… Released v{{.VERSION}}!"

  release:dry-run:
    desc: Test release build without publishing
    cmds:
      - echo "ğŸ§ª Running GoReleaser in snapshot mode..."
      - goreleaser release --snapshot --clean
      - echo "âœ… Dry run complete. Check dist/ for artifacts."

  release:check:
    desc: Validate GoReleaser configuration
    cmds:
      - goreleaser check
